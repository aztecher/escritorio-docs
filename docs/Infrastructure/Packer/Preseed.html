

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Preseed &mdash; SphinxRoot 1.0.0 ドキュメント</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="SphinxRoot 1.0.0 ドキュメント" href="../../index.html"/>
        <link rel="up" title="Packer Documents" href="index.html"/>
        <link rel="next" title="Ansible Documents" href="../Ansible/index.html"/>
        <link rel="prev" title="KickStart" href="KickStart.html"/> 

  
  <script src="../../static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> SphinxRoot
          

          
          </a>

          
            
            
              <div class="version">
                0.0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../Haskell/index.html">Haskell Documents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Golang/index.html">Golang Documents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../C/index.html">C Documents</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Infrastructure Documents</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Packer Documents</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="What_is_Packer.html">What is Packer</a></li>
<li class="toctree-l3"><a class="reference internal" href="Boxcutter.html">BoxCutter</a></li>
<li class="toctree-l3"><a class="reference internal" href="Examples.html">Examples</a></li>
<li class="toctree-l3"><a class="reference internal" href="KickStart.html">KickStart</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Preseed</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">オールインワン構成の手順</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../Ansible/index.html">Ansible Documents</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Vagrant/index.html">Vagrant Documents</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Docker/index.html">Docker Documents</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Kubernetes/index.html">Kubernetes Documents</a></li>
<li class="toctree-l2"><a class="reference internal" href="../OpenStack/index.html">OpenStack Documents</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Network/index.html">Network Documents</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../Micon/index.html">Micon Documents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Git/index.html">Git Documents</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">SphinxRoot</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Infrastructure Documents</a> &raquo;</li>
      
          <li><a href="index.html">Packer Documents</a> &raquo;</li>
      
    <li>Preseed</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../sources/Infrastructure/Packer/Preseed.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="preseed">
<h1>Preseed<a class="headerlink" href="#preseed" title="このヘッドラインへのパーマリンク">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">本来, PreseedとPackerは独立したツールであるが, Preseedに関しては現状Packerでの利用以外を考えていないため, このディレクトリに説明書きを載せておく.</p>
</div>
<p>PreseedはOSのインストールを自動化する仕組みである. <span class="xref doc">./KickStart.rst</span> と担う領域は同じであるといえる. <code class="docutils literal"><span class="pre">preseed.cfg</span></code> というファイルを作成し制御する.</p>
<p>Preseedを使うと言ってもインストール方法はいろいろある. それぞれメリデメがあるため, 必要な環境に応じて使い分けるのが無難.</p>
<ol class="arabic simple">
<li>ISOイメージに, <code class="docutils literal"><span class="pre">preseed.cfg</span></code> を同梱しオールインワンにする.</li>
<li>PXEブート方式. pxelinuxのイメージをTFTPで取得し, <code class="docutils literal"><span class="pre">preseed.cfg</span></code> をネットから取得して, それに従ってネットワークインストールする. DVDはいらないが, DHCPサーバーやTFTPサーバーの用意は必要.</li>
<li>1で作成するISOイメージで, <code class="docutils literal"><span class="pre">preseed.cfg</span></code> のセッテイのみネットワーク上からHTTPで取得する方法. DHCPサーバーが必要.</li>
</ol>
<p>今回はお試しとして, 1の方式で作成してみる. DHCPサーバーなどの環境をトト萌えたら2や3も試して記述しておくようにする.</p>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">ディレクトリやファイル名は適宜読み替える</p>
</div>
<div class="section" id="id1">
<h2>オールインワン構成の手順<a class="headerlink" href="#id1" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="section" id="iso">
<h3>ISOファイルのマウントとコピー<a class="headerlink" href="#iso" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>基本的には, ISOの中身を取りだし加工して詰め直すというような作業になるため, ISOの取り回しが必要になる. ここでは少し, コマンドラインから取り回す方法について記述しておく.</p>
<p>まず, ISOをマウントしファイルをコピーする.
.. code-block:: sh</p>
<blockquote>
<div>$ sudo mkdir -p /mnt/iso
$ sudo mount -o ro,loop ubuntu-16.04-server-amd64.iso /mnt/iso
$ mkdir iso_root
$ rsync -av /mnt/iso/. iso_root/.</div></blockquote>
</div>
<div class="section" id="iso-root-isolinux-isolinux-cfg">
<h3>iso_root/isolinux/isolinux.cfgの書き換え<a class="headerlink" href="#iso-root-isolinux-isolinux-cfg" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>timeout値を1に設定する.</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span>$ sudo vim iso_root/isolinux/isolinux.cfg
&gt; timeout: 1
</pre></div>
</div>
</div>
<div class="section" id="iso-root-isolinux-txt-cfg">
<h3>iso_root/isolinux/txt.cfgを書き換える<a class="headerlink" href="#iso-root-isolinux-txt-cfg" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>古くはisolinux.cfgで多くの設定が行われていた(らしい)が, Ubuntu16.04では, txt.cfgを中心に書き換えることになるそうな. 内容全体を次のように書き換える.</p>
<div class="highlight-cfg"><div class="highlight"><pre><span></span>default install
label install
  menu label ^Install Ubuntu Server
  kernel /install/vmlinuz
  append file=/cdrom/preseed/preseed.cfg vga=normal initrd=/install/initrd.gz auto=true locale=en_US.UTF-8 console-setup/charmap=UTF-8 console-setup/layoutcode=us console-setup/ask_detect=false pkgsel/language-pack-patterns=pkgsel/install-language-support=false quiet --
</pre></div>
</div>
<p>設定に記述されている, <code class="docutils literal"><span class="pre">/cdrom/preseed/preseed.cfg</span></code> のようなパスは, 作成するISOイメージがインストーラーでは, <code class="docutils literal"><span class="pre">/media</span></code> にマウントされている前提で記述している.</p>
</div>
<div class="section" id="iso-root-preseed-preseed-cfg">
<h3>iso_root/preseed/preseed.cfgを準備する<a class="headerlink" href="#iso-root-preseed-preseed-cfg" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>肝となる部分である. ただ基本的には人の設定をコピーして必要な部分だけ資料を参考にしながら編集する形になるだろう.</p>
<p>つまり, 以下は基本的にはテンプレとして考えてくれていい.</p>
<div class="highlight-cfg"><div class="highlight"><pre><span></span># ===================================================
# Boot sequence configuration start
# 後述する, Boot sequence configuration end
# の設定のところまではDVDメディア, USBメディアに
# 同梱している場合にのみ有効になる設定
# PXEブートの場合はこのセクションは無視される.
# この場合は, pxelinuxのconfigのappendに直接記入する
# ====================================================

# TODO: en, US を jpに変換するかどうかは試してから決める
# NOTES:
# 1. country = &#39;JP&#39; locale = en_US.UTF-8 はエラー -&gt; country = USとして解消
d-i debian-installer/language string en
d-i debian-installer/country string US
d-i debian-installer/locale string en_US.UTF-8
d-i localechooser/supported-locales en_US.UTF-98
d-i console-setup/ask_detect boolean false
d-i console-setup/layoutcode string us
d-i console-setup/charmap select UTF-8

# キーボードレイアウトの設定 (修正した)
d-i keyboard-configuration/layoutcode string us
d-i keyboard-configuration/modelcode us101

# =======================================================
# Network configuration
# =======================================================
#
# 静的IP
#
#   preseed.cfgを外からもてこようとするとどうしても一旦
#   DHCP解決をする必要がある.
#   そして, 以下の netcfg 項目は一回目は無視されるので,
#   d-i preseed/run のところでネットワーク設定をリセットする
#   ハックが必要になる.
#
#   詳しくは以下:
#   - https://help.ubuntu.com/lts/installation-guide/i386/preseed-contents.html
#   - http://debian.2.n7.nabble.com/Bug-688273-Preseed-netcfg-use-autoconfig-and-netcfg-disable-dhcp-doesn-t-work-td1910023.html
#
#   以下の2項目を設定しないと静的IPとして処理されないので重要
#
# ---
#
# d-i netcfg/use_autoconfig boolean false
# d-i netcfg/disable_autoconfig boolean true
#
# d-i netcfg/choose_interface select ens33
# d-i netcfg/disable_dhcp boolean true
# d-i netcfg/get_nameservers string 8.8.8.8 8.8.4.4 1.1.1.1
# d-i netcfg/get_ipaddress string 192.168.1.201
# d-i netcfg/get_netmask string 255.255.255.0
# d-i netcfg/get_gateway string 192.168.1.1
# d-i netcfg/confirm_static boolean true
# d-i netcfg/get_hostname string stack01
# d-i netcfg/get_domain string example.com
# d-i netcfg/wireless_wep string

#
# DHCP
#
# ---
#
# d-i netcfg/choose_interface select ens33
# d-i netcfg/disable_autoconfig boolean false
# d-i netcfg/get_hostname string openstack
# d-i netcfg/get_domain string sv.example.com
# d-i netcfg/wireless_wep string
#

#
# 一旦リセット
#
# ---
#
# d-i preseed/run string http://192.168.0.100/prescript.sh
#

#
# ALL IN ONE
#
# ---
#
# NOTES:
#   get_hostname, get_domain は必要に応じて修正する.
d-i netcfg/choose_interface select auto
d-i netcfg/get_hostname string unassigned-hostname
d-i netcfg/get_domain string localdomain

# =========================================================
# Boot sequence configuration end
# =========================================================

# インストーラーパッケージをダウンロードするミラーを選択
# d-i mirror/country string manual
# d-i mirror/http/hostname string jp.archive.ubuntu.com
# d-i mirror/http/directory string /ubuntu/
# d-i mirror/http/proxy string

d-i mirror/http/mirror select jp.archive.ubuntu.com

# ここらへんなにしてるんでしょ?
d-i apt-setup/restricted boolean true
d-i apt-setup/universe boolean true
d-i apt-setup/backports boolean true
d-i apt-setup/services-select multiselect security
d-i apt-setup/security_host string security.ubuntu.com
d-i apt-setup/security_path string /ubuntu

# インストールするSuiteの選択
d-i mirror/suite string xenial

# この辺は確認して変更する
# NOTES:
#   Passwordの入力・再入力を求められた
# 解決策:
#   passwd/user-password, passwd/user-passwordの入力
#
# NOTES:
#   username, passwordの設定は適切に行なう
#
d-i passwd/user-fullname string Admin User01
d-i passwd/username string ubuntu
d-i passwd/user-password password temppwd
d-i passwd/user-password-again password temppwd

d-i user-setup/allow-password-weak boolean true
d-i user-setup/encrypt-home boolean false

# 時刻設定
d-i clock-setup/utc boolean false
d-i time/zone string Asia/Tokyo
d-i clock-setup/ntp boolean true
d-i clock-setup/ntp-server string ntp.nict.jp

# ==========================================================
# Partman partitioning section start
# ==========================================================
#
# Partition Design
#
#   DiskSize: 80GiB
#
#   +------------+----------+-----------+
#   | MountPoint | Min Size |  Max Size |
#   +============+==========+===========+
#   | /boot      |     1GiB |      1GiB |
#   +------------+----------+-----------+
#   | /          |    50GiB | unlimited |
#   +------------+----------+-----------+
#   | swap       |    29GiB |     29GiB |
#   +------------+----------+-----------+
#
# Syntax
#   &lt;limits&gt;::&lt;minimal size&gt;_&lt;priority&gt;_&lt;maximum size&gt;_&lt;parted fs&gt;
#
# NOTES:
#   これに関しては場合により修正が必要.
#   また, MBPでなく, GPTの場合(大容量HDDを取り扱う場合)設定を少し変える必要がありそう.

# NOTES:
#  Partition disksで止まった
#  Partitioning methodを決めろとのこと.
#
#    Guided - use entire disk
#    Guided - use entire disk and set up LVM
#    Guided - use entier disk and setup encrypted LVM
#    Manual
#
#  とりあえずManual選んだらだめだった
#  そのため, 一番上のやつ選んだら, また選択画面 (DISKの選択?) を求められたので
#  出てきたディスクを選んだ
#
# 解決策
#  とりあえずいろいろtypeがあったのを修正した

# 全てのRAIDデバイス構成を破棄
d-i partman-md/device_remove_md boolean true
# 全てのLVMデバイス構成を破棄
d-i partman-lvm/device_remove_lvm boolean true
d-i partman/confirm_nooverwrite boolean true

# diskはsda一個
d-i partman-auto/disk string /dev/sda
d-i partman-auto/method string regular

# パーティショニング
d-i partman-auto/expert_recipe string \
      root ::                         \
        1024 10 1024 ext2             \
          $primary{ }                 \
          $bootable{ }                \
          format{ }                   \
          use_filesystem{ }           \
          filesystem{ ext2 }          \
          mountpoint{ /boot }         \
        .                             \
        51200 30 -1 ext4              \
          $primary{ }                 \
          method{ format }            \
          format{ }                   \
          use_filesystem{ }           \
          filesystem{ ext4 }          \
          mountpoint{ / }             \
        .                             \
        29696 20 29696 linux-swap     \
          $primary{ }                 \
          method { swap }             \
          format { }                  \
        .

d-i partman-auto/choose_recipe select root
d-i partman-partitioning/confirm_write_new_label boolean true
d-i partman/choose_partition select Finish partitioning and write changes to disk
d-i partman/confirm boolean true

# =====================================================
# Partman partitioning section end
# =====================================================

d-i base-installer/install-recommends boolean true
d-i base-installer/kernel/image string linux-generic

# NOTES:
#   正確にどこの表示かわからないがとりあえずこの辺に記述
#   Configure the package manager の HTTP Proxyの設定で止まった
#   使わない場合 blank と書いてあるのでそうするだけでいいだろうが
#   これのハンドリングも必要そう
#
# 解決策:
#
d-i mirror/http/proxy string

d-i apt-setup/use_mirror boolean true

d-i debian-installer/allow_unauthenticated boolean true
tasksel tasksel/first multiselect none

# select additional install package
# d-i pkgsel/include string openssh-server \
#                           tcpdump        \
#                           lvm2           \
#                           curl wget      \
d-i pkgsel/include string openssh-server
d-i pkgsel/upgrade select none
d-i pkgsel/update-policy select none
d-i pkgsel/install-language-support boolean true
popularity-contest popularity-contest/participate boolean false

# GRUB Installer
d-i grub-installer/grub2_instead_of_grub_legacy boolean true
d-i grub-installer/only_debian boolean true
d-i grub-installer/bootdev string /dev/sda

# reboot
d-i finish-install/reboot_in_progress note

# NOTES:
#   Select and install software
#   なんかエラー出た.
#   とりあえず以下, 文章抜粋
#
#   An installation step failed.
#   You can try to run the failing item again from the menu,
#   or skip it and choose something else.
#   The failing step is: Select and install software
#
#  うーんなんかソフトウェアインストールでエラーしてるっぽいな.
#
# 検証1:
#   とりあえず, pkgsel/include をopenssh-serverのみにしてみる.
#   -&gt; うまく行った. つまりコメントアウトしている中にそのままインストール出来ないものがありそう
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h3>isoイメージを作成する<a class="headerlink" href="#id2" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>iso_rootの準備がこれで整った. あとは次のコマンドでISOイメージを作成する. ファイル名に日付を入れることで上書きをしないようにしている.</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span>$ sudo genisoimage -N -J -R -D -V <span class="s2">&quot;PRESEED.UB1604&quot;</span> -o ubuntu-16.04-server-amd64-preseed.<span class="s2">&quot;</span><span class="k">$(</span>date +%Y%m%d.%H%M%S<span class="k">)</span><span class="s2">&quot;</span>.iso -b isolinux/isolinux.bin -c isolinux/boot.cat -no-emul-boot -boot-load-size <span class="m">4</span> -boot-info-table iso_root/
</pre></div>
</div>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../Ansible/index.html" class="btn btn-neutral float-right" title="Ansible Documents" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="KickStart.html" class="btn btn-neutral" title="KickStart" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, mikiyaf.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.0.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../static/jquery.js"></script>
      <script type="text/javascript" src="../../static/underscore.js"></script>
      <script type="text/javascript" src="../../static/doctools.js"></script>
      <script type="text/javascript" src="../../static/translations.js"></script>

  

  
  
    <script type="text/javascript" src="../../static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>