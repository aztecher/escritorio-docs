==========================
Installation & Setting
==========================

gdbのインストールと設定の話をする.

通常であればこのような話は省略するのであるが, MaxOSで起動する際には署名が必要になり. また, ある影響で署名が付いているのに動作しなかったりするため, これを回避するためのドキュメントとして残しておく.

ただし, このドキュメントも確認する時点では執筆当時(2018.10.16)の情報とは環境が違うことが想定されるため, あくまで参考程度に参照すること. とはいえ, 有益なTIPSは含んでいるようなドキュメントにするため, 当記事は一度すべて目を通すべきであろう.

また, 当記事は管渠としてOSは ``MacOS`` を前提としている. そうでない場合はおそらくこのようなTIPS集がなくても問題なくインストールから実行まで行なうことができるだろう.

Installation
==============

必要なものとしては, `gcc`, `Homebrew` である.
(`Homebrew` である必要はないが, 現在利用しているのがこれなのでこれに従う)

gdbのインストールをそのまま行なうと, 最新のgdbが入る.

しかし, これを入れてしまうと, 場合によってはエラーが起きてgdbコマンドが実行できないという減少に陥る. run実行時に以下のようなエラーがでるだろう.

.. code-block:: sh

    > gdb ./a.out
    ....

    > b main
    > run
    ....
    During startup program terminated with signal ....


これは, gdbのバージョンがOSのバージョンに対応していないなどの問題らしい. 詳しくは知らない. そのため, ダウングレードバージョンを指定してインストールする. 現時点では, ``gdb-8.2.0`` が最新バージョンであるが, ``gdb-8.0.1`` をダウンロードしてインストールする.

.. code-block:: sh

    brew install https://raw.githubusercontent.com/Homebrew/homebrew-core/9ec9fb27a33698fc7636afce5c1c16787e9ce3f3/Formula/gdb.rb


Certification
===============

インストールを行ったはいいが, 自己証明を行っていないと, run実行時に以下のようにエラーがでる.

.. code-block:: sh

    > run
    Starting program: (プログラムのパス) 
    Unable to find Mach task port for process-id xxxx: (os/kern) failure (0x5).
     (please check gdb is codesigned - see taskgated(8))


証明書の作り方, 適用方法に関しては以下の記事を参照するといい.

> https://qiita.com/yuzu_afro/items/988020dd65fb4f43962a


ここで, すでにコード署名されている場合, すでに署名されているという旨のエラーが出て署名できない. 今回このような記事を書いたのはコレが理由である. 後述するが, このような自体は起きる可能性があるので, これの対処法を示す.

といっても簡単で, 証明書を外す.

.. code-block:: sh

    codesign --remove-signature /usr/lcoal/bin/gdb

そして再度証明すればいい.

ただ, これで再度証明しようとしたがエラーになったので, 結局 ``brew uninstall`` を実行しアンインストール後, 再度インストールし署名を行った.

brew update の弊害
=======================

察しがついているかもしれないが, 今回は知らないうちにgdbが起動できなくなっており, 且つ署名は行われていたという特殊な事例にぶち当たったことの対処法としてドキュメントを残している.

おそらくだがこれは, ``brew update`` がかかった際に, ``gdb`` が更新されたことに起因していると想定される. そのため, アップデートがかからないようにしたいわけである. この時使えるのが, ``brew pin`` である. これを行なうと, 自動でアップデートしたり, アンインストールしたりすることができなくなる. ``brew unpin`` で解除できる.  現在, ``brew pin gdb`` で ``gdb`` に関しては更新しないようにして対照することにした.
