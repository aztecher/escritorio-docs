=================================
06. ioctl Implementation
=================================

前回までで, 基本的なシステムコール(open, close, read, write)の実装方法の解説を行った. また, 実際にラズパイのGPIO用デバドラを作成した.

今回は追加で, `ioctl` というシステムコールを実装してみる.


参考URL

* 組み込みLinuxデバイスドライバの作り方_


ioctl
==========

ioctlとは, 下記で定義されるシステムコールである.

.. code-block:: c

    #include<sys/ioctl.h>
    int ioctl(int d, int request, ...);

第一引数には, openで取得したファイルディスクリプタ(fd)を入れる. 第二引数はリクエストと呼ばれているが, 要はコマンドである. 第三引数(可変長)はパラメータになる. このioctlを使うことで, ドライバ側で自由にインターフェイスを追加できる.

今までは, cdevを使用してデバドラを作成してきた. これによって, カーネルからはキャラクタ型デバイスドライバとして認識されている. そのため, read/write でユーザアプリケーションとやり取りするときには, キャラクタ(char)型を使用していた. 簡単なやり取りならこれでいいが, 実際にデバイスを制御するときにこれでは不十分である. 例えば, SPIの通信速度設定だったり, I2Cのスレーブアドレス設定には数字を指定する必要があるが, これらは read/write だけではできない. このような場合に, デバドラ側でインターフェースを追加する.

NOTE
------

ioctlは各デバイスドライバで独自にコマンドとパラメータを定義していく.
そのため, ioctlを使用する際に確認すべき仕様(ヘッダ)は, `ioctl.h` ではなく, 各デバイスドライバが用意しているヘッダ(あるいはソースコード)になる. 今回は自分でデバドラを作って見るため, そこらへんの感覚がわかるだろう.


ioctlシステムコールハンドラの定義
=======================================

ヘッダの定義
--------------

繰り返すが, ioctlでは, デバドラ側で独自にコマンドとパラメータを定義する. コマンドはint型の数字, パラメータは, 通常は構造体になる. (パラメータはなしでもOK). これらの定義を書いたヘッダを作る. ユーザが使うときにも参照するため, 別ファイルとする.

流れとしては,

1. `ioctl` に必要な構造体やコマンドを記述したヘッダを定義する. このヘッダはデバイスドライバプログラム側(ハンドラとして登録する側) と, ユーザプログラム側(実際に使用する側) の両方から利用するため, ファイルを分割しておく.

2. デバイスドライバプログラムに, `ioctl` 用のハンドラを作成する. read/writeなどを作成したときと同様, 関数を定義し, そこにハンドラ(今回はコマンドによって, switch-caseで動作を変更するようなもの)を実装し, それをハンドラテーブル(以前作成した, open, release, read, writeなどを登録した `file_operations` 構造体)に登録する (登録する際のメンバーとしては, `.unlocked_ioctl`, `.compat_ioctl` がある).

3. ユーザプログラムから, `/dev/mydevice0` を開き, そのファイルディスクリプタと1で作成したコマンド, 及びパラメータを渡して, ioctl関数を呼び出すと, 2で実装した `ioctl` ハンドラが実行される. 終了後は忘れずファイルディスクリプタをクローズする.

* `ioctl` : :doc:`./../../Library/Sys/ioctl.h`
* `file_operations` 構造体の `.unlocked_ioctl`, `.compat_ioctl` : :doc:`./../../Library/Kernel/linux/fs.h`



.. ==============================
.. リンク
.. ==============================

.. _組み込みLinuxデバイスドライバの作り方: https://qiita.com/take-iwiw/items/ade0a73d4c05fc7961d3
